@{
    ViewBag.Title = "Order List";
    Layout = "~/Views/Shared/_Layout_admin.cshtml";
}

<div class="content-page">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
                    <div>
                        <h4 class="mb-3">Danh sách đơn hàng</h4>
                       
                    </div>
                    <a href="@Url.Action("Create", "Orders")" class="btn btn-primary add-list">
                        <i class="las la-plus mr-2"></i>Thêm đơn hàng
                    </a>
                </div>
            </div>

            <div class="col-lg-12">
                <div class="table-responsive rounded mb-3">
                    <table id="datatable" class="data-table table mb-0 tbl-server-info">
                        <thead class="bg-white text-uppercase">
                            <tr class="ligth ligth-data">
                                <th>ID</th>
                                <th>Người Đặt</th>
                                <th>Tổng Tiền</th>
                                <th>Mã Khuyến Mãi</th>
                                <th>Trạng Thái</th>
                                <th>Địa Chỉ Giao Hàng</th>
                                <th>Ngày Tạo</th>
                                <th>Chức Năng</th>
                            </tr>
                        </thead>
                        <tbody id="order-body" class="ligth-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xác nhận xóa -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title text-dark">Xác nhận xóa</h5>
                </div>
                <div class="modal-body">
                    Bạn có chắc muốn xóa đơn hàng này?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-warning mt-2" data-dismiss="modal">Hủy</button>
                    <button id="confirmDelete" class="btn btn-warning mt-2">Xóa</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        let deleteId = 0;

        function loadOrders() {
            $.ajax({
                url: '@Url.Action("GetOrders", "Orders")',
                type: 'GET',
                success: function (data) {
                    let tbody = $("#order-body");
                    tbody.empty();

                    data.forEach(o => {
                        tbody.append(`
                            <tr>

                                <td>${o.Id}</td>
                                <td>${o.User}</td>
                                <td>${o.Total_Amount.toLocaleString()} ₫</td>
                                <td>${o.Promo}</td>
                                <td><span class="badge badge-info">${o.Status}</span></td>
                                <td>${o.Shipping_Address ?? "—"}</td>
                                <td>${o.Created}</td>

                                <td>
                                    <div class="d-flex align-items-center list-action">
                                        <a class="badge badge-info mr-2" href="/Orders/Details/${o.Id}">
                                            <i class="ri-eye-line mr-0"></i>
                                        </a>
                                        <a class="badge bg-success mr-2" href="/Orders/Edit/${o.Id}">
                                            <i class="ri-pencil-line mr-0"></i>
                                        </a>
                                        <a class="badge bg-warning mr-2 btn-delete-order" data-id="${o.Id}">
                                            <i class="ri-delete-bin-line mr-0"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        `);
                    });

                    $("#datatable").DataTable();
                },
                error: function () {
                    alert("Lỗi khi tải dữ liệu đơn hàng!");
                }
            });
        }

        $(document).ready(function () {
            loadOrders();

            // Nhấn nút xóa
            $(document).on("click", ".btn-delete-order", function () {
                deleteId = $(this).data("id");
                $("#deleteModal").modal("show");
            });

            // Xác nhận xóa
            $("#confirmDelete").click(function () {
                $.ajax({
                    url: '/Orders/DeleteOrder/' + deleteId,
                    type: 'POST',
                    success: function () {
                        $("#deleteModal").modal("hide");

                        $("#datatable").DataTable().destroy();
                        loadOrders();
                    },
                    error: function () {
                        alert("Lỗi hệ thống!");
                    }
                });
            });
        });
    </script>
}
